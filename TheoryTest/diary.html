<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Orion Drive - Diary</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .diary-card { background: #fff; border-radius: 15px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-top: 20px; }
        .lesson-item { border-left: 4px solid #007bff; padding: 10px 15px; margin-bottom: 15px; background: #f8f9fa; border-radius: 0 8px 8px 0; }
        .lesson-date { font-weight: bold; color: #333; display: block; }
        .lesson-desc { font-size: 0.9rem; color: #666; }
        .input-group { margin-bottom: 15px; }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 0.9rem; margin-top: 5px; }
        .status-pill { font-size: 0.7rem; padding: 4px 8px; border-radius: 10px; display: inline-block; margin-top: 10px; }
        .status-syncing { background: #fff3cd; color: #856404; }
        .status-ready { background: #d4edda; color: #155724; }
        #debug-log { margin-top: 20px; font-family: monospace; font-size: 0.6rem; color: #999; white-space: pre-wrap; word-break: break-all; border-top: 1px solid #eee; padding-top: 10px; }
        .footer-text { color: #8e8e93 !important; font-size: 0.65rem !important; font-family: sans-serif !important; text-transform: none; }
    </style>
</head>
<body>
    <div class="container">
        <div style="text-align: center; margin-bottom: 20px;">
            <h1 style="color: #333; margin-bottom: 5px;">My Lessons</h1>
            <p style="color: #8e8e93; font-size: 0.8rem;">Orion Drive Diary</p>
        </div>

        <div class="diary-card">
            <div class="input-group">
                <label style="font-size: 0.8rem; color: #666;">Enter Your Name</label>
                <input type="text" id="studentName" placeholder="e.g. Lewis" oninput="saveNameAndFilter()" />
            </div>

            <button class="btn btn-blue" onclick="syncDiary()" style="width: 100%; margin-top: 10px;">Check for Lessons</button>

            <div id="diary-status" style="display: none;">
                <span id="status-text" class="status-pill status-ready">Ready</span>
            </div>

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <div id="lesson-list">
                <p style="text-align: center; color: #999; font-size: 0.9rem;">Tap button to sync with Total Drive.</p>
            </div>
            
            <div id="debug-log"></div>
        </div>

        <p style="text-align: center; margin-top: 20px;">
            <a href="mainmenu.html" style="color: #007bff; text-decoration: none; font-size: 0.9rem;">&larr; Back to Menu</a>
        </p>

        <div class="card-footer" style="text-align: center; margin-top: 30px;">
            <span class="footer-text">ORION DRIVE ● DIARY ● v1.0.4</span>
        </div>
    </div>

    <script>
        const TD_LINK = "https://web.totaldrive.app/calsync/?id=11693755868-1006";
        const debug = (msg) => { document.getElementById('debug-log').innerText += "\n" + msg; };

        window.onload = () => {
            const savedName = localStorage.getItem('orion_student_name');
            if (savedName) {
                document.getElementById('studentName').value = savedName;
            }
        };

        function saveNameAndFilter() {
            const name = document.getElementById('studentName').value;
            localStorage.setItem('orion_student_name', name);
            if (window.allLessons) displayLessons(window.allLessons);
        }

        async function syncDiary() {
            const list = document.getElementById('lesson-list');
            const statusDiv = document.getElementById('diary-status');
            const statusText = document.getElementById('status-text');
            const logger = document.getElementById('debug-log');

            logger.innerText = "Log Start:";
            statusDiv.style.display = 'block';
            statusText.innerText = "Syncing...";
            statusText.className = "status-pill status-syncing";
            list.innerHTML = "<p style='text-align:center;'>Updating diary...</p>";

            try {
                // Using AllOrigins to pull the data silently
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(TD_LINK)}&timestamp=${Date.now()}`;
                
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`Network Error: ${response.status}`);
                
                const data = await response.json();
                const rawText = data.contents;
                debug("Data fetched successfully.");

                window.allLessons = parseICS(rawText);
                displayLessons(window.allLessons);
                
                statusText.innerText = "Updated: " + new Date().toLocaleTimeString();
                statusText.className = "status-pill status-ready";
            } catch (err) {
                console.error(err);
                statusText.innerText = "Sync Failed";
                statusText.className = "status-pill";
                statusText.style.background = "#f8d7da";
                statusText.style.color = "#721c24";
                list.innerHTML = "<p style='text-align:center; color:red;'>Check internet connection.</p>";
                debug("Error: " + err.message);
            }
        }

        function parseICS(icsString) {
            const events = [];
            const lines = icsString.split(/\r?\n/);
            let currentEvent = null;

            lines.forEach(line => {
                if (line.startsWith("BEGIN:VEVENT")) {
                    currentEvent = {};
                } else if (line.startsWith("END:VEVENT")) {
                    if (currentEvent && currentEvent.start) events.push(currentEvent);
                    currentEvent = null;
                } else if (currentEvent) {
                    if (line.startsWith("SUMMARY:")) currentEvent.summary = line.replace("SUMMARY:", "").trim();
                    if (line.startsWith("DTSTART:")) currentEvent.start = line.replace("DTSTART:", "").trim();
                }
            });

            const now = new Date().toISOString().replace(/[-:]/g, '').split('.')[0];
            return events.filter(e => e.start >= now).sort((a, b) => a.start.localeCompare(b.start));
        }

        function displayLessons(lessons) {
            const list = document.getElementById('lesson-list');
            const filter = document.getElementById('studentName').value.trim().toLowerCase();
            
            if (!filter) {
                list.innerHTML = `<p style="text-align:center; color:#999;">Please enter your name above.</p>`;
                return;
            }

            const filtered = lessons.filter(l => l.summary.toLowerCase().includes(filter));

            if (filtered.length === 0) {
                list.innerHTML = `<p style="text-align:center; color:#999;">No upcoming lessons found for "${filter}".</p>`;
                return;
            }

            list.innerHTML = "";
            filtered.slice(0, 5).forEach(lesson => {
                const dateStr = formatICSDate(lesson.start);
                list.innerHTML += `
                    <div class="lesson-item">
                        <span class="lesson-date">${dateStr}</span>
                        <span class="lesson-desc">${lesson.summary}</span>
                    </div>
                `;
            });
        }

        function formatICSDate(icsDate) {
            const y = icsDate.substring(0, 4);
            const m = parseInt(icsDate.substring(4, 6)) - 1;
            const d = icsDate.substring(6, 8);
            const hh = icsDate.substring(9, 11);
            const mm = icsDate.substring(11, 13);
            
            const dateObj = new Date(Date.UTC(y, m, d, hh, mm));
            return dateObj.toLocaleDateString('en-GB', { 
                weekday: 'short', 
                day: 'numeric', 
                month: 'short', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
    </script>
</body>
</html>
