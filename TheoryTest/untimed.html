<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Theory Test - No Timer</title>
    <style>
        body {
            font-family: -apple-system, sans-serif;
            background-color: #000;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }
        .card {
            background: #1c1c1e;
            padding: 2rem;
            border-radius: 24px;
            text-align: center;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-top: 50px;
            border: 1px solid #2c2c2e;
            position: relative;
        }
        h2 { color: #007bff; margin: 0; font-size: 1.5rem; }
        input {
            background: #000;
            border: 1px solid #444;
            color: #007bff;
            padding: 12px;
            font-size: 1.2rem;
            width: 80%;
            text-align: center;
            border-radius: 8px;
            margin: 20px 0;
            font-family: monospace;
        }
        button {
            background: #007bff;
            color: #fff;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
        }
        #test-ui { width: 100%; max-width: 600px; display: none; }
        .v-tag {
            position: absolute;
            bottom: 10px;
            right: 15px;
            font-family: monospace;
            font-size: 0.6rem;
            color: #444;
        }
        #debug-box {
            margin-top: 40px;
            padding: 15px;
            border: 1px dashed #444;
            font-family: monospace;
            font-size: 0.8rem;
            color: #8e8e93;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="lock-ui" class="card">
        <h2>Theory Test - No Timer</h2>
        <p style="color:#8e8e93;font-size:0.9rem">Monthly Access Required</p>
        <input type="text" id="passCode" placeholder="ENTER CODE" autocomplete="off">
        <br>
        <button onclick="verifyAccess()">Unlock System</button>
        <span class="v-tag">v1.4.3</span>
    </div>

    <div id="test-ui">
        <h1>Test Active</h1>
        <div id="content-area"></div>
    </div>

    <div id="debug-box" style="display:none"></div>

    <script>
        const DEBUGZ = 1; 
        const ALPH = "ABCDEFGHJKMNPQRTUVWXYZ2346789#";

        // Generate the 5-character token (4 base + 1 check)
        function calcKey() {
            const d = new Date();
            const s = new Date(Date.UTC(d.getFullYear(), d.getMonth(), 1, 0, 0, 0));
            const e = new Date(Date.UTC(1900, 0, 1, 0, 0, 0));
            const m = Math.floor((s.getTime() - e.getTime()) / 60000);
            
            let v = m % Math.pow(32, 4);
            let r = "";
            for (let j = 0; j < 4; j++) {
                r = ALPH.charAt(v % 32) + r;
                v = Math.floor(v / 32);
            }
            while (r.length < 4) { r = ALPH.charAt(0) + r; }

            let t = 0;
            let ra = r.split('').reverse();
            for (let j = 0; j < ra.length; j++) {
                let x = ALPH.indexOf(ra[j]);
                if (j % 2 === 0) {
                    x *= 2;
                    if (x >= 32) x = (x % 32) + Math.floor(x / 32);
                }
                t += x;
            }
            let ci = (32 - (t % 32)) % 32;
            return r + (ALPH[ci] || ALPH[0]);
        }

        const targetKey = calcKey();
        const curMonthID = new Date().getUTCMonth() + "-" + new Date().getUTCFullYear();

        function init() {
            const savedMonth = localStorage.getItem('q_month');
            const hasData = localStorage.getItem('questions_json');

            // If month matches and data exists, skip the lock
            if (savedMonth === curMonthID && hasData) {
                runTheoryTest();
            } else {
                document.getElementById('lock-ui').style.display = 'block';
            }

            // Debug features
            if (DEBUGZ) {
                const db = document.getElementById('debug-box');
                db.style.display = 'block';
                db.innerHTML = `DEBUG: Expected [${targetKey}]<br><br>
                <button onclick="localStorage.clear();location.reload();" 
                style="background:#444;font-size:0.7rem;color:#fff;padding:5px;border-radius:4px;border:none">
                FORCE DELETE LOCAL JSON</button>`;
            }
        }

        async function verifyAccess() {
            const input = document.getElementById('passCode').value.toUpperCase();
            if (input === targetKey) {
                try {
                    const response = await fetch('questions.json');
                    if (!response.ok) throw new Error();
                    const data = await response.json();
                    
                    // Save for the month
                    localStorage.setItem('questions_json', JSON.stringify(data));
                    localStorage.setItem('q_month', curMonthID);
                    
                    runTheoryTest();
                } catch (e) {
                    alert("Code correct, but questions.json missing or failed to download.");
                }
            } else {
                // Wipe data on fail
                localStorage.removeItem('questions_json');
                localStorage.removeItem('q_month');
                alert("Incorrect Code. Local data wiped.");
                location.reload();
            }
        }

        function runTheoryTest() {
            document.getElementById('lock-ui').style.display = 'none';
            document.getElementById('test-ui').style.display = 'block';
            const data = JSON.parse(localStorage.getItem('questions_json'));
            
            // This is where your test UI logic would take over
            document.getElementById('content-area').innerHTML = "Questions loaded. System Active.";
            console.log("Data loaded for test:", data);
        }

        window.onload = init;
    </script>
</body>
</html>
